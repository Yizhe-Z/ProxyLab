>option timing 1
>option locking 1
>option semaphore 1
>proxy ./proxy
Proxy set up at bambooshark.ics.cs.cmu.edu:3948
>option stretch 200
>source '/afs/andrew.cmu.edu/usr3/yizhez/private/proxylab-s20-zhaoyizhe312/tests/D06-multi-server2.cmd'
># Make sure caches for different servers are not mixed.  Binary data
>serve s1 s2
Server s1 running at bambooshark.ics.cs.cmu.edu:11348
Server s2 running at bambooshark.ics.cs.cmu.edu:3648
>generate random-binary1.bin 100K
>generate random-binary2.bin 100K
>generate random-binary3.bin 100K
># Request first version of files from server s1
>request r1a random-binary1.bin s1
Client: Requesting '/random-binary1.bin' from bambooshark.ics.cs.cmu.edu:11348
>request r2a random-binary2.bin s1
Client: Requesting '/random-binary2.bin' from bambooshark.ics.cs.cmu.edu:11348
>request r3a random-binary3.bin s1
Client: Requesting '/random-binary3.bin' from bambooshark.ics.cs.cmu.edu:11348
>wait *
Proxy stderr: zyzyz: -1
Proxy stderr: GET /random-binary2.bin HTTP/1.0
Proxy stderr: Host: bambooshark.ics.cs.cmu.edu:11348
Proxy stderr: Request-ID: r2a
Proxy stderr: Response: Deferred
Proxy stderr: User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:3.10.0) Gecko/20191101 Firefox/63.0.1
Proxy stderr: Connection: close
Proxy stderr: Proxy-Connection: close
Proxy stderr: 
Proxy stderr: zyzyz: -1
Proxy stderr: GET /random-binary1.bin HTTP/1.0
Proxy stderr: Host: bambooshark.ics.cs.cmu.edu:11348
Proxy stderr: Request-ID: r1a
Proxy stderr: Response: Deferred
Proxy stderr: User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:3.10.0) Gecko/20191101 Firefox/63.0.1
Proxy stderr: Connection: close
Proxy stderr: Proxy-Connection: close
Proxy stderr: 
Proxy stderr: zyzyz: -1
Proxy stderr: GET /random-binary3.bin HTTP/1.0
Proxy stderr: Host: bambooshark.ics.cs.cmu.edu:11348
Proxy stderr: Request-ID: r3a
Proxy stderr: Response: Deferred
Proxy stderr: User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:3.10.0) Gecko/20191101 Firefox/63.0.1
Proxy stderr: Connection: close
Proxy stderr: Proxy-Connection: close
Proxy stderr: 
># Out of order response will fail with sequential proxy
>respond r3a r2a r1a
Server responded to request r3a with status ok
Server responded to request r2a with status ok
Server responded to request r1a with status ok
>wait *
Proxy stderr: large_flag: 0, size: 100193
Proxy stderr: left_size: 948383
Proxy stderr: large_flag: 0, size: 100193
Proxy stderr: large_flag: 0, size: 100193
Proxy stderr: left_size: 848190
Proxy stderr: left_size: 747997
>check r1a
Request r1a yielded expected status 'ok'
>check r2a
Request r2a yielded expected status 'ok'
>check r3a
Request r3a yielded expected status 'ok'
>delete random-binary1.bin
>delete random-binary2.bin
>delete random-binary3.bin
># Generate files with same names, but different contents
>generate random-binary1.bin 99K
>generate random-binary2.bin 99K
>generate random-binary3.bin 99K
># Request first version of files from server s2
>request r1b random-binary1.bin s2
Client: Requesting '/random-binary1.bin' from bambooshark.ics.cs.cmu.edu:3648
>request r2b random-binary2.bin s2
Client: Requesting '/random-binary2.bin' from bambooshark.ics.cs.cmu.edu:3648
>request r3b random-binary3.bin s2
Client: Requesting '/random-binary3.bin' from bambooshark.ics.cs.cmu.edu:3648
>wait *
Proxy stderr: zyzyz: -1
Proxy stderr: GET /random-binary1.bin HTTP/1.0
Proxy stderr: Host: bambooshark.ics.cs.cmu.edu:3648
Proxy stderr: Request-ID: r1b
Proxy stderr: Response: Deferred
Proxy stderr: User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:3.10.0) Gecko/20191101 Firefox/63.0.1
Proxy stderr: Connection: close
Proxy stderr: Proxy-Connection: close
Proxy stderr: 
Proxy stderr: zyzyz: -1
Proxy stderr: GET /random-binary2.bin HTTP/1.0
Proxy stderr: Host: bambooshark.ics.cs.cmu.edu:3648
Proxy stderr: Request-ID: r2b
Proxy stderr: Response: Deferred
Proxy stderr: User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:3.10.0) Gecko/20191101 Firefox/63.0.1
Proxy stderr: Connection: close
Proxy stderr: Proxy-Connection: close
Proxy stderr: 
Proxy stderr: zyzyz: -1
Proxy stderr: GET /random-binary3.bin HTTP/1.0
Proxy stderr: Host: bambooshark.ics.cs.cmu.edu:3648
Proxy stderr: Request-ID: r3b
Proxy stderr: Response: Deferred
Proxy stderr: User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:3.10.0) Gecko/20191101 Firefox/63.0.1
Proxy stderr: Connection: close
Proxy stderr: Proxy-Connection: close
Proxy stderr: 
># Since these requests were to a different server,
># the responses should come from server, not from cache.
>respond r1b r2b r3b
Server responded to request r1b with status ok
Server responded to request r2b with status ok
Server responded to request r3b with status ok
>wait *
Proxy stderr: large_flag: 0, size: 99192
Proxy stderr: left_size: 648805
Proxy stderr: large_flag: 0, size: 99192
Proxy stderr: left_size: 549613
Proxy stderr: large_flag: 0, size: 99192
Proxy stderr: left_size: 450421
>check r1b
Request r1b yielded expected status 'ok'
>check r2b
Request r2b yielded expected status 'ok'
>check r3b
Request r3b yielded expected status 'ok'
># Check for caching
>request r1c random-binary1.bin s2
Client: Requesting '/random-binary1.bin' from bambooshark.ics.cs.cmu.edu:3648
>wait *
Proxy stderr: zyzyz: 1
>check r1c
Request r1c yielded expected status 'ok'
>quit
Testing done.  Elapsed time = 5.05 seconds
ALL TESTS PASSED
