>option timing 1
>option locking 1
>option semaphore 1
>proxy ./proxy
Proxy set up at bambooshark.ics.cs.cmu.edu:8454
>option stretch 200
>source '/afs/andrew.cmu.edu/usr3/yizhez/private/proxylab-s20-zhaoyizhe312/tests/D05-multi-server1.cmd'
># Make sure caches for different servers are not mixed
># This test can be passed by a sequential proxy
>serve s1 s2
Server s1 running at bambooshark.ics.cs.cmu.edu:22919
Server s2 running at bambooshark.ics.cs.cmu.edu:16969
>generate random-text1.txt 100K
>generate random-text2.txt 100K
>generate random-text3.txt 100K
># Serve first versions of the files using server s1
>fetch f1a random-text1.txt s1
Client: Fetching '/random-text1.txt' from bambooshark.ics.cs.cmu.edu:22919
>fetch f2a random-text2.txt s1
Client: Fetching '/random-text2.txt' from bambooshark.ics.cs.cmu.edu:22919
>fetch f3a random-text3.txt s1
Client: Fetching '/random-text3.txt' from bambooshark.ics.cs.cmu.edu:22919
>wait *
Proxy stderr: zyzyz: -1
Proxy stderr: GET /random-text1.txt HTTP/1.0
Proxy stderr: Host: bambooshark.ics.cs.cmu.edu:22919
Proxy stderr: Request-ID: f1a
Proxy stderr: Response: Immediate
Proxy stderr: User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:3.10.0) Gecko/20191101 Firefox/63.0.1
Proxy stderr: Connection: close
Proxy stderr: Proxy-Connection: close
Proxy stderr: 
Proxy stderr: zyzyz: -1
Proxy stderr: GET /random-text2.txt HTTP/1.0
Proxy stderr: Host: bambooshark.ics.cs.cmu.edu:22919
Proxy stderr: Request-ID: f2a
Proxy stderr: Response: Immediate
Proxy stderr: User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:3.10.0) Gecko/20191101 Firefox/63.0.1
Proxy stderr: Connection: close
Proxy stderr: Proxy-Connection: close
Proxy stderr: 
Proxy stderr: zyzyz: -1
Proxy stderr: GET /random-text3.txt HTTP/1.0
Proxy stderr: Host: bambooshark.ics.cs.cmu.edu:22919
Proxy stderr: Request-ID: f3a
Proxy stderr: Response: Immediate
Proxy stderr: User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:3.10.0) Gecko/20191101 Firefox/63.0.1
Proxy stderr: Connection: close
Proxy stderr: Proxy-Connection: close
Proxy stderr: 
Proxy stderr: large_flag: 0, size: 100177
Proxy stderr: left_size: 948399
Proxy stderr: large_flag: 0, size: 100177
Proxy stderr: left_size: 848222
Proxy stderr: large_flag: 0, size: 100177
Proxy stderr: left_size: 748045
>check f1a
Request f1a yielded expected status 'ok'
>check f2a
Request f2a yielded expected status 'ok'
>check f3a
Request f3a yielded expected status 'ok'
># Make sure caching occurred
>request r1a random-text1.txt s1
Client: Requesting '/random-text1.txt' from bambooshark.ics.cs.cmu.edu:22919
>wait r1a
Proxy stderr: zyzyz: 1
>check r1a
Request r1a yielded expected status 'ok'
>delete random-text1.txt
>delete random-text2.txt
>delete random-text3.txt
># Create new files with same names but different contents
>generate random-text1.txt 99K
>generate random-text2.txt 99K
>generate random-text3.txt 99K
># Serve second versions of the files using server s2
>request r1b random-text1.txt s2
Client: Requesting '/random-text1.txt' from bambooshark.ics.cs.cmu.edu:16969
>request r2b random-text2.txt s2
Client: Requesting '/random-text2.txt' from bambooshark.ics.cs.cmu.edu:16969
>request r3b random-text3.txt s2
Client: Requesting '/random-text3.txt' from bambooshark.ics.cs.cmu.edu:16969
>wait r1b
Proxy stderr: zyzyz: -1
Proxy stderr: GET /random-text1.txt HTTP/1.0
Proxy stderr: Host: bambooshark.ics.cs.cmu.edu:16969
Proxy stderr: Request-ID: r1b
Proxy stderr: Response: Deferred
Proxy stderr: User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:3.10.0) Gecko/20191101 Firefox/63.0.1
Proxy stderr: Connection: close
Proxy stderr: Proxy-Connection: close
Proxy stderr: 
Proxy stderr: zyzyz: -1
Proxy stderr: GET /random-text2.txt HTTP/1.0
Proxy stderr: Host: bambooshark.ics.cs.cmu.edu:16969
Proxy stderr: Request-ID: r2b
Proxy stderr: Response: Deferred
Proxy stderr: User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:3.10.0) Gecko/20191101 Firefox/63.0.1
Proxy stderr: Connection: close
Proxy stderr: Proxy-Connection: close
Proxy stderr: 
>respond r1b
Server responded to request r1b with status ok
>wait r2b
>respond r2b 
Server responded to request r2b with status ok
>wait r3b
Proxy stderr: zyzyz: -1
Proxy stderr: GET /random-text3.txt HTTP/1.0
Proxy stderr: Host: bambooshark.ics.cs.cmu.edu:16969
Proxy stderr: Request-ID: r3b
Proxy stderr: Response: Deferred
Proxy stderr: User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:3.10.0) Gecko/20191101 Firefox/63.0.1
Proxy stderr: Connection: close
Proxy stderr: Proxy-Connection: close
Proxy stderr: 
>respond r3b
Server responded to request r3b with status ok
># Since these requests were to a different server,
># the responses should come from server, not from cache.
>#
># Respond in order
>respond r1b r2b r3b
Server responded to request r1b with status ok
Server responded to request r2b with status ok
Server responded to request r3b with status ok
>wait *
Proxy stderr: large_flag: 0, size: 99176
Proxy stderr: left_size: 648869
Proxy stderr: large_flag: 0, size: 99176
Proxy stderr: large_flag: 0, size: 99176
Proxy stderr: left_size: 549693
Proxy stderr: left_size: 450517
>check r1b
Request r1b yielded expected status 'ok'
>check r2b
Request r2b yielded expected status 'ok'
>check r3b
Request r3b yielded expected status 'ok'
>quit
Testing done.  Elapsed time = 2.87 seconds
ALL TESTS PASSED
